---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

// OG image: use custom image if set, otherwise the generated one
const ogImage = post.data.image || `/og/${post.slug}.png`;

// Related posts: match by country, category, or documentType
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug)
  .map((p) => {
    let score = 0;
    if (post.data.country && p.data.country === post.data.country) score += 3;
    if (post.data.documentType && p.data.documentType === post.data.documentType) score += 2;
    if (p.data.category === post.data.category) score += 1;
    return { post: p, score };
  })
  .filter((r) => r.score > 0)
  .sort((a, b) => b.score - a.score || new Date(b.post.data.publishedDate).getTime() - new Date(a.post.data.publishedDate).getTime())
  .slice(0, 3)
  .map((r) => r.post);

const categories: Record<string, string> = {
  apostillas: 'Apostillas',
  documentos: 'Documentos',
  tramites: 'Trámites',
  guias: 'Guías',
  noticias: 'Noticias',
};

// Convertir fechas a Date objects
const publishedDate = new Date(post.data.publishedDate);
const updatedDate = post.data.updatedDate ? new Date(post.data.updatedDate) : null;

// Schema.org Article
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description: post.data.description,
  image: `https://tramitia.es${ogImage}`,
  datePublished: publishedDate.toISOString(),
  dateModified: updatedDate?.toISOString() || publishedDate.toISOString(),
  author: {
    '@type': 'Organization',
    name: 'Tramitia',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Tramitia',
    logo: {
      '@type': 'ImageObject',
      url: 'https://tramitia.es/logo.png',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://tramitia.es/blog/${post.slug}/`,
  },
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Inicio',
      item: 'https://tramitia.es/',
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Blog',
      item: 'https://tramitia.es/blog/',
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: post.data.title,
      item: `https://tramitia.es/blog/${post.slug}/`,
    },
  ],
};
---

<BaseLayout
  title={`${post.data.title} | Tramitia`}
  description={post.data.description}
  image={ogImage}
  article={true}
  publishedTime={publishedDate.toISOString()}
  modifiedTime={updatedDate?.toISOString()}
  keywords={post.data.keywords}
>
  <Fragment slot="schema">
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  </Fragment>

  <article class="max-w-3xl mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="text-sm text-primary/60 mb-8">
      <a href="/" class="hover:text-accent">Inicio</a>
      <span class="mx-2">/</span>
      <a href="/blog/" class="hover:text-accent">Blog</a>
      <span class="mx-2">/</span>
      <span class="text-primary/80">{post.data.title}</span>
    </nav>

    <!-- Header -->
    <header class="mb-10">
      {post.data.category && (
        <span class="inline-block bg-accent/10 text-accent text-sm font-medium px-3 py-1 rounded-full mb-4">
          {categories[post.data.category] || post.data.category}
        </span>
      )}
      <h1 class="text-3xl md:text-4xl font-bold text-primary mb-4 leading-tight">
        {post.data.title}
      </h1>
      <p class="text-xl text-primary/70 mb-6">
        {post.data.description}
      </p>
      <div class="flex items-center gap-4 text-sm text-primary/60">
        <span>Por {post.data.author}</span>
        <span class="w-1 h-1 bg-primary/40 rounded-full"></span>
        <time datetime={publishedDate.toISOString()}>
          {publishedDate.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })}
        </time>
        {updatedDate && updatedDate.getTime() !== publishedDate.getTime() && (
          <>
            <span class="w-1 h-1 bg-primary/40 rounded-full"></span>
            <span>
              Actualizado: {updatedDate.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </span>
          </>
        )}
      </div>
    </header>

    <!-- Featured Image -->
    <img
      src={ogImage}
      alt={post.data.title}
      class="w-full aspect-video object-cover rounded-xl mb-10"
      loading="eager"
    />

    <!-- Content -->
    <div class="prose prose-lg max-w-none
                prose-headings:font-semibold prose-headings:text-primary
                prose-p:text-primary/80
                prose-a:text-accent prose-a:no-underline hover:prose-a:underline
                prose-img:rounded-lg
                prose-blockquote:border-l-accent prose-blockquote:bg-muted-light prose-blockquote:py-1 prose-blockquote:text-primary/70
                prose-strong:text-primary
                prose-ul:text-primary/80 prose-ol:text-primary/80
                prose-table:text-primary/80 prose-th:text-primary prose-th:font-semibold
                prose-td:border-muted/30 prose-th:border-muted/30">
      <Content />
    </div>

    <!-- CTA Box -->
    <div class="mt-12 p-8 bg-accent/5 rounded-xl border border-accent/20">
      <h3 class="text-xl font-semibold text-primary mb-2">
        ¿Necesitas apostillar tus documentos?
      </h3>
      <p class="text-primary/70 mb-4">
        Gestionamos tu apostilla de forma rápida y segura. Sin volver a tu país.
      </p>
      <a
        href="/#contacto"
        class="inline-block bg-accent text-white px-6 py-3 rounded-lg font-medium hover:bg-accent-600 transition"
      >
        Solicitar presupuesto gratis
      </a>
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <aside class="mt-12">
        <h2 class="text-2xl font-bold text-primary mb-6">Artículos relacionados</h2>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5">
          {relatedPosts.map((related) => (
            <a href={`/blog/${related.slug}/`} class="block bg-white rounded-xl border border-muted/20 overflow-hidden hover:shadow-lg transition-all duration-200 group">
              <div class="aspect-video overflow-hidden">
                <img
                  src={related.data.image || `/og/${related.slug}.png`}
                  alt={related.data.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
                  loading="lazy"
                />
              </div>
              <div class="p-4">
                {related.data.category && (
                  <span class="inline-block bg-accent/10 text-accent text-xs font-semibold px-2 py-0.5 rounded-md mb-2">
                    {categories[related.data.category] || related.data.category}
                  </span>
                )}
                <h3 class="text-base font-semibold text-primary group-hover:text-accent transition line-clamp-2">
                  {related.data.title}
                </h3>
              </div>
            </a>
          ))}
        </div>
      </aside>
    )}

    <!-- Back to blog -->
    <div class="mt-12 pt-8 border-t border-muted">
      <a href="/blog/" class="inline-flex items-center gap-2 text-accent font-medium hover:underline">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Volver al blog
      </a>
    </div>
  </article>
</BaseLayout>
